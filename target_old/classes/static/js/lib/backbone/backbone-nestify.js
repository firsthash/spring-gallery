(function(a){if(typeof module==="object"){module.exports=a(require("underscore"),require("backbone"))}else{if(typeof define==="function"&&define.amd){define(["underscore","backbone"],a)}else{this.nestify=a(this._,this.Backbone)}}}(function(g,f){var i=Array.prototype.slice;var h={existy:function(j){return j!=null},defaultOpts:{coll:"at",delim:"|"},lookupPath:function(k,j){return g.reduce(k,function(l,n){var o;if(l){if(g.isNumber(n)){o=(l instanceof f.Collection?l.at(n):l[n])}else{o=(l instanceof f.Model?l.attributes[n]:l[n])}}return o},j)},properNum:function(j){return(/^([0-9]+)$/.test(j))?parseInt(j,10):j},withProperNums:function(j){return g.map(j,h.properNum)},delimitedStringToArray:function(k,l){var j=l.delim;if(!h.existy(k)){return[]}else{if(g.isArray(k)){return k}else{if(g.isString(k)&&k.indexOf(j)>-1){return h.withProperNums(k.split(j))}else{return[k]}}}},toObj:function(l,k){var j;if(g.isObject(l)&&!(g.isArray(l))){j=l}else{if((g.isArray(l)||g.isString(l))){l=(g.isArray(l)?l:[l]);j=g.reduceRight(l,function(o,n){var m;if(g.isNumber(n)){m=[]}else{m={}}m[n]=o;return m},k)}}return j},coerceArray:function(j){if(!h.existy(j)){j=[]}return j},assertArray:function(j){if(!(g.isArray(j))){console.log("**WARNING**! expected array but found: "+JSON.stringify(j))}},prepAttributes:function(k,j,l){l=l||{};j=g.reduce(j,function(o,n,m){var p=(this.attributes&&this.attributes[m]),q=c.findContainerFn(k,m,n,p,l);o[m]=q(n,p,l,m,this);return o},{},this);return j},hasChangedDeep:function(k,m,j){var l=f.Model.prototype.hasChanged.call(this,j);if(!l&&m){l=g.reduce(this.attributes,function(p,o,n){if(!p){if(o instanceof f.Model){p=k.call(o,k,m)}else{if(o instanceof f.Collection){p=o.reduce(function(r,q){return r||k.call(q,k,m)},p)}}}return p},l)}return l}};var d={stringMatcher:function(k,j){return k===j},regexMatcher:function(k,j){return k.test(j)},matchAll:function(){return true},useUnmodified:function(k,j,m,l){return(this.isModel(k,j)||this.isCollection(k,j)||(l.unset&&!h.existy(j)))},isModel:function(k,j){return j instanceof f.Model},isExistingModel:function(k,j,l){return l instanceof f.Model},isCollection:function(k,j){return j instanceof f.Collection},isExistingCollection:function(k,j,l){return l instanceof f.Collection},isArray:function(k,j){return g.isArray(j)},isArrayOfObjects:function(k,j){return g.isArray(j)&&g.every(j,g.isObject)},isExistingArray:function(k,j,l){return g.isArray(l)},isObject:function(k,j){return g.isObject(j)},isExistingObject:function(k,j,l){return g.isObject(l)},and:function(){var j=i.call(arguments);return function(){var k=i.call(arguments);return g.reduce(j,function(l,m){return(l&&m.apply(this,k))},true,this)}},or:function(){var j=i.call(arguments);return function(){var k=i.call(arguments);return g.reduce(j,function(l,m){return(l||m.apply(this,k))},false,this)}},not:function(j){return function(){return !j.apply(this,arguments)}}};g.bindAll(d,"useUnmodified");var c={determineType:function(k){var j;if(k instanceof f.Model){j="model"}else{if(k instanceof f.Collection){j="collection"}else{if(g.isArray(k)){j="array"}else{if(g.isObject(k)){j="object"}}}}return j},isBackbone:function(j){return g.contains(["model","collection"],j)},findContainerFn:function(o,n,m,l,k){var j=g.find(o,function(p){return p._matcherFn(n,m,l,k)});return j._containerFn},object:{merge:function(k,j){return g.extend({},k,j)},reset:function(k,j){return j}},array:{merge:function(k,j){return g.map(g.zip(j,k),g.compose(g.first,g.compact))},reset:function(k,j){return j}},model:{merge:function(l,j,k){l.set(j,k);return l},reset:function(l,j,k){l.clear();l.set(j,k);return l}},collection:{reset:function(j,m,k){m=h.coerceArray(m);h.assertArray(m);var l=j.model;j.reset(g.map(m,function(n){return new l(n,k)}),k);return j},smartMerge:function(j,m,k){m=h.coerceArray(m);h.assertArray(m);var l=j.model;j.set(g.map(m,function(n){return new l(n,k)}),k);return j},merge:function(k,o,m){o=h.coerceArray(o);h.assertArray(o);var n=k.model;var l=g.zip(k.models,o);var j=g.map(l,function(s){var q=s[0],r=s[1],p=q;if(r){if(q){q.set(r,m)}else{p=new n(r,m)}}return p});k.set(j,m);return k}}};var e={defaults:{object:"reset",array:"reset",collection:"merge",model:"merge"},object:{reset:c.object.reset,merge:c.object.merge,smart:c.object.merge},array:{reset:c.array.reset,merge:c.array.merge,smart:c.array.merge},model:{reset:c.model.reset,merge:c.model.merge,smart:c.model.merge},collection:{reset:c.collection.reset,merge:c.collection.merge,smart:c.collection.smartMerge}};var a={determineTypeFromConstructor:function(k){var j;if(k===f.Model||k.prototype instanceof f.Model){j="model"}else{if(k===f.Collection||k.prototype instanceof f.Collection){j="collection"}else{if(k===Array){j="array"}else{if(k===Object){j="object"}}}}return j},compileConstructorFn:function(k,m){var j=h.existy(m),l=c.isBackbone(m);return function(q,r,p,n){var o=j?l?new k.constructor(k.args,r):new k.constructor():k.constructor(k.args,r,p,n);if(k.spec){g.extend(o,b(k.spec))}return o}},compileContainerFn:function(j){j=g.isFunction(j)?{constructor:j}:j;var l=this.determineTypeFromConstructor(j.constructor),k=this.compileConstructorFn(j,l);return function(n,q,o){o=j.opts?g.extend({},o,j.opts):o;var m=q?q:k(n,o);l=l||c.determineType(m);var r=o.update||e.defaults[l],p=e[l];return p[r](m,n,o)}},compileExistingContainerFn:function(j){var k=e[j],l=e.defaults[j];return function(m,o,n){var p=n.update||l;return k[p](o,m,n)}},compile:function(j,l){var k,m;if(g.isArray(j)){k=j}else{if(g.isObject(j)){k=[{hash:j}]}else{k=[]}}m=[{_matcherFn:d.useUnmodified,_containerFn:g.identity}];m=g.reduce(k,function(p,o){if(o.hash){g.each(o.hash,function(r,q){p.push({_matcherFn:g.partial(d.stringMatcher,q),_containerFn:this.compileContainerFn(r)})},this)}else{var n={_containerFn:this.compileContainerFn(o.container)};if(g.isRegExp(o.match)){n._matcherFn=g.partial(d.regexMatcher,o.match)}else{if(g.isString(o.match)){n._matcherFn=g.partial(d.stringMatcher,o.match)}else{if(g.isFunction(o.match)){n._matcherFn=o.match}else{n._matcherFn=d.matchAll}}}p.push(n)}return p},m,this);m.push({_matcherFn:d.isExistingCollection,_containerFn:this.compileExistingContainerFn("collection")},{_matcherFn:d.isExistingModel,_containerFn:this.compileExistingContainerFn("model")},{_matcherFn:d.isExistingArray,_containerFn:this.compileExistingContainerFn("array")},{_matcherFn:d.isExistingObject,_containerFn:this.compileExistingContainerFn("object")});m.push({_matcherFn:d.matchAll,_containerFn:g.identity});l.compiled=m;return m}};var b=g.extend(function(j,k){var l=g.extend({},h.defaultOpts,k);j=a.compile(j,l);return{get:function(n,m){m=g.extend({},l,m);n=h.delimitedStringToArray(n,m);return h.lookupPath(n,this)},set:function(o,p,n){var m;if(!g.isArray(o)&&g.isObject(o)){n=g.extend({},l,p);m=o instanceof f.Model?o.attributes:o}else{n=g.extend({},l,n);o=h.delimitedStringToArray(o,n);m=h.toObj(o,p)}if(g.isObject(m)&&!(n instanceof f.Model)){m=h.prepAttributes.call(this,j,m,n)}return f.Model.prototype.set.call(this,m,n)},hasChanged:function(m,o){if(g.isObject(m)&&!g.isArray(m)){o=g.extend({},l,m);m=[]}else{o=g.extend({},l,o);m=h.delimitedStringToArray(m,o)}var p=g.initial(m),n=h.lookupPath(p,this);return n?h.hasChangedDeep.call(n,h.hasChangedDeep,(o.nested===true),g.last(m)):false}}},{auto:function(k){k=k||{};var n=f.Model.extend(k.extend),m=f.Collection.extend({model:n});var j=[{match:d.isArrayOfObjects,container:m},{match:d.and(d.isObject,d.not(d.isArray)),container:g.extend({constructor:n},k)}];var l=b(j,k);g.extend(n.prototype,l);return l},instance:function(k,j,l){if(k instanceof f.Model){g.extend(k,j||b(l));var m=k.attributes;k.attributes={};k.set(m,l)}return k},_pathToObject:h.toObj,_properNum:h.properNum});return b}));